class <%= @migration_class_name %> < ActiveRecord::Migration[<%= ActiveRecord::Migration.current_version %>]
  def change
<%- unless update? || only_trigger? -%>
    add_column :<%= table_name %>, :log_data, :json
<%- end -%>

    reversible do |dir|
      dir.up do
  <%- if update? -%>
        execute <<~SQL
          DROP TRIGGER IF EXISTS logidze_before_insert_on_<%= full_table_name %>;
        SQL
        execute <<~SQL
          DROP TRIGGER IF EXISTS logidze_before_update_on_<%= full_table_name %>;
        SQL

  <%- end -%>
        execute <<~SQL
<%= inject_sql("logidze_update.sql", indent: 10) %>
        SQL
        execute <<~SQL
<%= inject_sql("logidze_insert.sql", indent: 10) %>
        SQL
      end

      dir.down do
        execute <<~SQL
          DROP TRIGGER IF EXISTS logidze_before_insert_on_<%= full_table_name %>;
        SQL
        execute <<~SQL
          DROP TRIGGER IF EXISTS logidze_before_update_on_<%= full_table_name %>;
        SQL
      end
    end
<%- if backfill? -%>

    reversible do |dir|
      dir.up do
        execute <<~SQL
          UPDATE <%= full_table_name %> as t
          SET log_data = logidze_snapshot(<%= logidze_snapshot_parameters %>);
        SQL
      end
    end
<%- end -%>
  end
end
