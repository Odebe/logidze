version: '7'

compose:
  files:
    - docker-compose.yml

templates:
  "rspec.tests": &specs_template
    description: Run specs other than spec/acceptance
    service: ruby
    command: bundle exec rspec --exclude-pattern spec/acceptance/**/*_spec.rb

  "rspec.acceptance": &acceptance_template
    description: Run acceptance specs in spec/acceptance
    service: ruby
    command: bundle exec rspec spec/acceptance/**/*_spec.rb

interaction:
  bash:
    description: Open the Bash shell in app's container
    service: ruby
    command: /bin/bash

  bundle:
    description: Run Bundler commands
    service: ruby
    command: bundle

  "rspec.mysql":
    description: Run Rspec commands against mysql
    environment:
      DATABASE_URL: mysql2://root:mysql@mysql:3306
      FORCE_DB_RESET: true
    subcommands:
      acceptance:
        <<: *acceptance_template
      specs:
        <<: *specs_template

  "rspec.postgres":
    description: Run Rspec commands against postgresql
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5455
      FORCE_DB_RESET: true
    subcommands:
      acceptance:
        <<: *acceptance_template
      specs:
        <<: *specs_template

  "postgres.createdb":
    description: Run PostgreSQL createdb command
    service: postgres
    command: createdb -h postgres -U postgres logidze_test

  "mysql.createdb":
    description: create db in mysql
    service: mysql
    command: mysql -hmysql -uroot -pmysql -e "CREATE DATABASE IF NOT EXISTS logidze_test";

provision:
#  - dip bundle config --local build.pg -- --with-pg-config=/usr/local/opt/libpq/bin/pg_config
#  - dip bundle config --local build.mysql2 -- $(ruby -r rbconfig -e 'puts RbConfig::CONFIG["configure_args"]' | xargs -n1 | grep with-openssl-dir)
  - dip bundle install
  - dip mysql.createdb
  - dip postgres.createdb
